import os
import json
import argparse
import requests

GITHUB_API = "https://api.github.com/graphql"

def run_query(query, token):
    headers = {"Authorization": f"Bearer {token}"}
    response = requests.post(GITHUB_API, json={"query": query}, headers=headers)
    if response.status_code != 200:
        raise Exception(f"Query failed: {response.status_code}, {response.text}")
    return response.json()

def get_repo_id(owner, repo, token):
    query = f"""
    {{
      repository(owner: "{owner}", name: "{repo}") {{
        id
      }}
    }}
    """
    data = run_query(query, token)
    return data["data"]["repository"]["id"]

def create_project(repo_id, title, token):
    query = f"""
    mutation {{
      createProjectV2(input: {{
        ownerId: "{repo_id}",
        title: "{title}"
      }}) {{
        projectV2 {{
          id
          title
        }}
      }}
    }}
    """
    data = run_query(query, token)
    return data["data"]["createProjectV2"]["projectV2"]

def add_item_with_string_field(project_id, field_id, string_value, token):
    """
    Add a project item and set a string field.
    - project_id: ID of the project
    - field_id: ID of the text field in the project
    - string_value: string to store
    """
    mutation = f"""
    mutation {{
      addProjectV2ItemById(input: {{
        projectId: "{project_id}",
        fieldValues: [
          {{
            fieldId: "{field_id}",
            text: "{string_value}"
          }}
        ]
      }}) {{
        item {{
          id
        }}
      }}
    }}
    """
    run_query(mutation, token)

def get_text_field_id(project_id, token):
    """Fetch the first text field ID from the project (assumes one exists)"""
    query = f"""
    {{
      node(id: "{project_id}") {{
        ... on ProjectV2 {{
          fields(first: 10) {{
            nodes {{
              id
              name
              dataType
            }}
          }}
        }}
      }}
    }}
    """
    data = run_query(query, token)
    fields = data["data"]["node"]["fields"]["nodes"]
    for f in fields:
        if f["dataType"] == "singleLineText":  # use text field
            return f["id"]
    raise Exception("No single-line text field found in project. Please add one manually.")

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--owner", required=True)
    parser.add_argument("--repo", required=True)
    parser.add_argument("--token", required=True)
    parser.add_argument("--project-title", required=True)
    parser.add_argument("--pair-data", required=True, help="JSON file with mentor-mentee pairs")
    args = parser.parse_args()

    token = args.token
    repo_id = get_repo_id(args.owner, args.repo, token)
    project = create_project(repo_id, args.project_title, token)
    project_id = project["id"]
    print(f"âœ… Created project: {project['title']} (ID: {project_id})")

    # Get the first text field ID to store mentor â†’ mentee string
    field_id = get_text_field_id(project_id, token)

    # Load mentor-mentee pairs
    with open(args.pair_data, "r") as f:
        pairs = json.load(f)

    for pair in pairs:
        mentor = pair["mentor_email"]
        mentee = pair["mentee_email"]
        string_value = f"{mentor} â†’ {mentee}"
        add_item_with_string_field(project_id, field_id, string_value, token)

    print(f"ðŸ’¾ Added {len(pairs)} mentor-mentee pairs to project.")

if __name__ == "__main__":
    main()
